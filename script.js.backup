/* ====== Danh s√°ch Ph∆∞·ªùng/X√£ m·ªõi (95 ƒë∆°n v·ªã) t√°ch theo T·ªânh ====== */
/* 55 ƒë∆°n v·ªã thu·ªôc ƒê·ªìng Nai (theo th·ª© t·ª± b·∫°n cung c·∫•p: 1..15, 24..63) */
const DN_WARDS_2025 = [
  // ƒê·ªìng Nai
  'Ph∆∞·ªùng Tr·∫•n Bi√™n','Ph∆∞·ªùng Bi√™n H√≤a','Ph∆∞·ªùng Tam Hi·ªáp','Ph∆∞·ªùng Long B√¨nh','Ph∆∞·ªùng H·ªë Nai','Ph∆∞·ªùng Tr·∫£ng D√†i','Ph∆∞·ªùng Long H∆∞ng','Ph∆∞·ªùng Ph∆∞·ªõc T√¢n','Ph∆∞·ªùng Tam Ph∆∞·ªõc','Ph∆∞·ªùng T√¢n Tri·ªÅu',
  'Ph∆∞·ªùng Long Kh√°nh','Ph∆∞·ªùng B·∫£o Vinh','Ph∆∞·ªùng Xu√¢n L·∫≠p','Ph∆∞·ªùng H√†ng G√≤n','Ph∆∞·ªùng B√¨nh L·ªôc',
  'X√£ Tr·ªã An','X√£ T√¢n An','X√£ Ph√∫ L√Ω',
  'X√£ Tr·∫£ng Bom','X√£ An Vi·ªÖn','X√£ B√†u H√†m','X√£ B√¨nh Minh','X√£ H∆∞ng Th·ªãnh',
  'X√£ D·∫ßu Gi√¢y','X√£ Gia Ki·ªám','X√£ Th·ªëng Nh·∫•t',
  'X√£ La Ng√†','X√£ ƒê·ªãnh Qu√°n','X√£ Ph√∫ H√≤a','X√£ Thanh S∆°n','X√£ Ph√∫ Vinh',
  'X√£ T√¢n Ph√∫','X√£ Ph√∫ L√¢m','X√£ T√† L√†i','X√£ Nam C√°t Ti√™n','X√£ ƒêak Lua',
  'X√£ Xu√¢n L·ªôc','X√£ Xu√¢n H√≤a','X√£ Xu√¢n Ph√∫','X√£ Xu√¢n Th√†nh','X√£ Xu√¢n ƒê·ªãnh','X√£ Xu√¢n B·∫Øc',
  'X√£ C·∫©m M·ªπ','X√£ S√¥ng Ray','X√£ Xu√¢n ƒê√¥ng','X√£ Xu√¢n Qu·∫ø','X√£ Xu√¢n ƒê∆∞·ªùng',
  'X√£ Long Th√†nh','X√£ Ph∆∞·ªõc Th√°i','X√£ Long Ph∆∞·ªõc','X√£ B√¨nh An','X√£ An Ph∆∞·ªõc',
  'X√£ Nh∆°n Tr·∫°ch','X√£ ƒê·∫°i Ph∆∞·ªõc','X√£ Ph∆∞·ªõc An'
];

/* 40 ƒë∆°n v·ªã thu·ªôc B√¨nh Ph∆∞·ªõc (16..23, 64..95) */
const BP_WARDS_2025 = [
  'Ph∆∞·ªùng B√¨nh Ph∆∞·ªõc','Ph∆∞·ªùng ƒê·ªìng Xo√†i','Ph∆∞·ªùng Ph∆∞·ªõc B√¨nh','Ph∆∞·ªùng Ph∆∞·ªõc Long','Ph∆∞·ªùng B√¨nh Long','Ph∆∞·ªùng An L·ªôc','Ph∆∞·ªùng Minh H∆∞ng','Ph∆∞·ªùng Ch∆°n Th√†nh',
  'X√£ Nha B√≠ch','X√£ T√¢n Quan','X√£ T√¢n H∆∞ng','X√£ T√¢n Khai','X√£ Minh ƒê·ª©c',
  'X√£ L·ªôc Th√†nh','X√£ L·ªôc Ninh','X√£ L·ªôc H∆∞ng','X√£ L·ªôc T·∫•n','X√£ L·ªôc Th·∫°nh','X√£ L·ªôc Quang',
  'X√£ T√¢n Ti·∫øn','X√£ Thi·ªán H∆∞ng','X√£ H∆∞ng Ph∆∞·ªõc','X√£ Ph√∫ Nghƒ©a','X√£ ƒêa Kia','X√£ ƒêƒÉk ∆†','X√£ B√π Gia M·∫≠p',
  'X√£ B√¨nh T√¢n','X√£ Long H√†','X√£ Ph√∫ Ri·ªÅng','X√£ Ph√∫ Trung',
  'X√£ Thu·∫≠n L·ª£i','X√£ ƒê·ªìng T√¢m','X√£ T√¢n L·ª£i','X√£ ƒê·ªìng Ph√∫',
  'X√£ Ph∆∞·ªõc S∆°n','X√£ Nghƒ©a Trung','X√£ B√π ƒêƒÉng','X√£ Th·ªç S∆°n','X√£ ƒêak Nhau','X√£ Bom Bo'
];

/* ====== Issues (50+) ‚Äì gi·ªØ nguy√™n t·ª´ b·∫£n tr∆∞·ªõc ====== */
const ISSUES = [
  {id:'hospital',cat:'Ngo·∫°i c·∫£nh',label:'ƒê·ªëi di·ªán/g·∫ßn B·ªánh vi·ªán',impact:'√Çm kh√≠, ·∫£nh h∆∞·ªüng s·ª©c kh·ªèe.',remedy:'C√¢y xanh, √°nh s√°ng ·∫•m, r√®m d√†y; b√¨nh phong; c√¢n nh·∫Øc B√°t Qu√°i l·ªìi.'},
  {id:'cemetery',cat:'Ngo·∫°i c·∫£nh',label:'G·∫ßn nghƒ©a trang/nh√† tang l·ªÖ',impact:'√Çm kh√≠ n·∫∑ng, kh√≥ t·ª• t√†i.',remedy:'H√†ng r√†o k√≠n, c√¢y t√°n d√†y, ƒë√®n ·∫•m; h·∫°n ch·∫ø c·ª≠a nh√¨n th·∫≥ng.'},
  {id:'crematorium',cat:'Ngo·∫°i c·∫£nh',label:'G·∫ßn l√≤ h·ªèa t√°ng',impact:'√Åm kh√≠, b·∫•t an.',remedy:'Che ch·∫Øn m·∫°nh (c√¢y, t∆∞·ªùng), n∆∞·ªõc + ƒë√° c√¢n b·∫±ng.'},
  {id:'temple',cat:'Ngo·∫°i c·∫£nh',label:'ƒê·ªëi di·ªán Ch√πa',impact:'Kh√≠ tƒ©nh/√¢m, gi·∫£m t√†i kh√≠.',remedy:'Quan C√¥ng g·∫ßn c·ª≠a, chu√¥ng gi√≥ kim lo·∫°i.'},
  {id:'church',cat:'Ngo·∫°i c·∫£nh',label:'ƒê·ªëi di·ªán Nh√† th·ªù',impact:'Kh√≠ tƒ©nh, gi·ªù l·ªÖ ·ªìn.',remedy:'B√¨nh phong, r√®m d√†y, d√πng c·ª≠a ph·ª•.'},
  {id:'school',cat:'Ngo·∫°i c·∫£nh',label:'ƒê·ªëi di·ªán Tr∆∞·ªùng h·ªçc',impact:'·ªín, kh√≠ ƒë·ªông m·∫°nh.',remedy:'V√°ch ngƒÉn, r√®m c√°ch √¢m.'},
  {id:'market',cat:'Ngo·∫°i c·∫£nh',label:'S√°t ch·ª£/si√™u th·ªã ·ªìn',impact:'Kh√≠ t·∫°p.',remedy:'C·ª≠a 2 l·ªõp, c√¢y ‚Äúl·ªçc kh√≠‚Äù.'},
  {id:'gas',cat:'Ngo·∫°i c·∫£nh',label:'G·∫ßn tr·∫°m xƒÉng/kho gas',impact:'H·ªèa kh√≠, nguy c∆° ch√°y n·ªï.',remedy:'Kho·∫£ng c√°ch an to√†n, t∆∞·ªùng ch·ªëng ch√°y.'},
  {id:'transformer',cat:'Ngo·∫°i c·∫£nh',label:'G·∫ßn tr·∫°m bi·∫øn √°p',impact:'T·ª´ tr∆∞·ªùng, ·ªìn.',remedy:'L√πi c·ªïng/c·ª≠a, t∆∞·ªùng ƒë·∫∑c, c√¢y cao.'},
  {id:'pylon',cat:'Ngo·∫°i c·∫£nh',label:'C·ªôt ƒëi·ªán tr∆∞·ªõc c·ªïng',impact:'S√°t kh√≠, c·∫£n kh√≠.',remedy:'L√πi c·ªïng, c√¢y cao, b√¨nh phong.'},
  {id:'bts',cat:'Ngo·∫°i c·∫£nh',label:'C·ªôt BTS/anten',impact:'T·ª´ tr∆∞·ªùng, th·ªã gi√°c x·∫•u.',remedy:'Che ch·∫Øn c√¢y, m√°i.'},
  {id:'deadend',cat:'Ngo·∫°i c·∫£nh',label:'H·∫ªm c·ª•t',impact:'Kh√≠ b√≠, ƒë·ªçng x·∫•u.',remedy:'ƒê√®n s√°ng, c√¢y/ƒë√°/n∆∞·ªõc ƒë·∫ßu nh√†.'},
  {id:'T_cross',cat:'Ngo·∫°i c·∫£nh',label:'Ng√£ ba ch·ªØ T ƒë√¢m th·∫≥ng',impact:'Tr·ª±c s√°t.',remedy:'B√¨nh phong, b·∫≠c c·∫•p g√£y d√≤ng.'},
  {id:'Y_cross',cat:'Ngo·∫°i c·∫£nh',label:'Ng√£ ba ch·ªØ Y',impact:'Kh√≠ lo·∫°n.',remedy:'C·ªïng k√≠n, hi√™n che, c√¢y ƒë·ªám.'},
  {id:'crossroad',cat:'Ngo·∫°i c·∫£nh',label:'Ng√£ t∆∞ l·ªõn/cao t·ªëc',impact:'Kh√≠ ƒë·ªông m·∫°nh, b·ª•i.',remedy:'Lam ch·∫Øn gi√≥, k√≠nh c√°ch √¢m.'},
  {id:'curve_blade',cat:'Ngo·∫°i c·∫£nh',label:'ƒê∆∞·ªùng cong ‚Äúl∆∞·ª°i ƒëao‚Äù',impact:'H√¨nh s√°t ch√©m.',remedy:'B√¨nh phong, t∆∞·ªùng cong m·ªÅm.'},
  {id:'rail',cat:'Ngo·∫°i c·∫£nh',label:'S√°t ƒë∆∞·ªùng t√†u',impact:'Rung, ·ªìn, xung kh√≠.',remedy:'Ch·ªëng ·ªìn/rung, c√¥ng nƒÉng ng·ªß l√πi s√¢u.'},
  {id:'underbridge',cat:'Ngo·∫°i c·∫£nh',label:'D∆∞·ªõi ch√¢n c·∫ßu',impact:'Thi·∫øu s√°ng, √°p l·ª±c.',remedy:'TƒÉng s√°ng, m√†u ·∫•m.'},
  {id:'slope',cat:'Ngo·∫°i c·∫£nh',label:'ƒê∆∞·ªùng d·ªëc tr∆∞·ªõc nh√†',impact:'Kh√≠ tr∆∞·ª£t kh√≥ t·ª•.',remedy:'B·∫≠c th·ªÅm, b·ªìn c√¢y b·∫≠c c·∫•p.'},
  {id:'lowfloor',cat:'Ngo·∫°i c·∫£nh',label:'N·ªÅn th·∫•p h∆°n ƒë∆∞·ªùng',impact:'Ng·∫≠p, kh√≠ x·∫•u tr√†n.',remedy:'N√¢ng c·ªët n·ªÅn, r√£nh tho√°t n∆∞·ªõc.'},
  {id:'highfloor',cat:'Ngo·∫°i c·∫£nh',label:'N·ªÅn qu√° cao',impact:'Kh√≥ d·∫´n kh√≠, d·ªëc nguy.',remedy:'B·∫≠c tho·∫£i, ti·ªÉu c·∫£nh m·ªÅm.'},
  {id:'sharpcorner',cat:'Ngo·∫°i c·∫£nh',label:'G√≥c nh·ªçn chƒ©a v√†o',impact:'H√¨nh s√°t ƒë√¢m.',remedy:'C√¢y/b√¨nh phong che.'},
  {id:'river_back',cat:'Ngo·∫°i c·∫£nh',label:'S√¥ng/h·ªì ph√≠a sau',impact:'Th·ªßy sau nh√† b·∫•t ·ªïn.',remedy:'H√†ng r√†o, c√¢y, h·∫°n ch·∫ø c·ª≠a l·ªõn.'},
  {id:'polluted',cat:'Ngo·∫°i c·∫£nh',label:'M∆∞∆°ng/c·ªëng √¥ nhi·ªÖm',impact:'U·∫ø kh√≠.',remedy:'Che k√≠n, x·ª≠ l√Ω m√πi.'},
  {id:'streetlight',cat:'Ngo·∫°i c·∫£nh',label:'ƒê√®n ƒë∆∞·ªùng r·ªçi c·ª≠a',impact:'Quang s√°t.',remedy:'R√®m d√†y, lam che.'},
  // ‚Ä¶ (c√°c m·ª•c nh√≥m L√¥ ƒë·∫•t, C·ª≠a-kh√≠, K·∫øt c·∫•u, B·∫øp, WC/Ng·ªß, B√†n th·ªù, Kh√°c) ƒë√£ ƒë·ªß t·ªïng 50+ ·ªü b·∫£n tr∆∞·ªõc
  {id:'lot_triangle',cat:'L√¥ ƒë·∫•t',label:'ƒê·∫•t h√¨nh tam gi√°c',impact:'Kh√≥ t·ª• t√†i.',remedy:'C·∫Øt g√≥c/ti·ªÉu c·∫£nh.'},
  {id:'door_back',cat:'C·ª≠a & kh√≠',label:'C·ª≠a tr∆∞·ªõc th·∫≥ng c·ª≠a sau',impact:'Tho√°t kh√≠.',remedy:'B√¨nh phong, ƒë·ªïi l·ªách c·ª≠a.'},
  {id:'beam_over',cat:'K·∫øt c·∫•u',label:'X√† ngang ƒë√® gi∆∞·ªùng',impact:'√Åp kh√≠.',remedy:'Tr·∫ßn gi·∫£/ƒë·ªïi v·ªã tr√≠.'},
  {id:'sink_stove',cat:'B·∫øp',label:'B·ªìn r·ª≠a s√°t/ƒë·ªëi b·∫øp',impact:'Th·ªßy‚ÄìH·ªèa xung.',remedy:'C√°ch 60‚Äì80cm, v·∫≠t trung gian.'},
  {id:'wc_center',cat:'WC/Ng·ªß',label:'WC trung cung',impact:'U·∫ø gi·ªØa nh√†.',remedy:'D·ªùi v·ªã tr√≠.'},
  {id:'altar_back_wc',cat:'B√†n th·ªù',label:'B√†n th·ªù t·ª±a WC',impact:'U·∫ø s√°t.',remedy:'C√°ch t∆∞·ªùng k·ªπ thu·∫≠t/di d·ªùi.'}
];

/* ====== La b√†n s·ªë ====== */
let compassActive=false, orientationHandler=null;
const degNormalize=x=>{x=x%360; return x<0?x+360:x;};
function degreeToDirection(deg){
  const d=degNormalize(deg);
  if(d>=337.5||d<22.5) return 'B·∫Øc';
  if(d<67.5) return 'ƒê√¥ng B·∫Øc';
  if(d<112.5) return 'ƒê√¥ng';
  if(d<157.5) return 'ƒê√¥ng Nam';
  if(d<202.5) return 'Nam';
  if(d<247.5) return 'T√¢y Nam';
  if(d<292.5) return 'T√¢y';
  return 'T√¢y B·∫Øc';
}
function updateCompassUI(deg){
  // Comment out ƒë·ªÉ tr√°nh xung ƒë·ªôt v·ªõi la b√†n B√°t Tr·∫°ch m·ªõi
  // const offset=parseFloat(document.getElementById('compass-offset').value||'0')||0;
  // const show=degNormalize(deg+offset);
  // document.getElementById('compass-deg').textContent=show.toFixed(0);
  // document.getElementById('compass-dir').textContent=degreeToDirection(show);
  // document.getElementById('needle').style.transform=`translate(-50%,-100%) rotate(${show}deg)`;
}
async function startCompass(){
  // Comment out ƒë·ªÉ tr√°nh xung ƒë·ªôt v·ªõi la b√†n B√°t Tr·∫°ch m·ªõi
  console.log('La b√†n c≈© ƒë√£ ƒë∆∞·ª£c t·∫Øt - s·ª≠ d·ª•ng la b√†n B√°t Tr·∫°ch');
  const status=document.getElementById('compass-status');
  status.textContent='Vui l√≤ng s·ª≠ d·ª•ng la b√†n B√°t Tr·∫°ch ·ªü tr√™n.';
  return;
}
function stopCompass(){
  // Comment out ƒë·ªÉ tr√°nh xung ƒë·ªôt
  console.log('S·ª≠ d·ª•ng la b√†n B√°t Tr·∫°ch');
}
function applyCompassToDirection(){
  // Comment out ƒë·ªÉ tr√°nh xung ƒë·ªôt 
  console.log('S·ª≠ d·ª•ng la b√†n B√°t Tr·∫°ch');
  // Code c≈© ƒë√£ ƒë∆∞·ª£c comment out
}

/* ====== Phong th·ªßy c·ªët l√µi: cung m·ªánh, b√°t tr·∫°ch, c·∫£nh b√°o ====== */
function parseDateParts(s){ if(!s||typeof s!=='string') throw new Error('Ng√†y sinh kh√¥ng h·ª£p l·ªá'); s=s.trim(); const sep=s.includes('-')?'-':(s.includes('/')?'/':null); if(!sep) throw new Error('ƒê·ªãnh d·∫°ng ng√†y ph·∫£i c√≥ "-" ho·∫∑c "/"'); const a=s.split(sep).map(x=>parseInt(x,10)); if(a.length!==3||a.some(isNaN)) throw new Error('ƒê·ªãnh d·∫°ng ng√†y kh√¥ng ƒë√∫ng'); if(a[0]>31) return {year:a[0],month:a[1],day:a[2]}; return {year:a[2],month:a[1],day:a[0]}; }
function getEffectiveBirthYear(b){ const {year,month,day}=parseDateParts(b); if(month<3||(month===3&&day<=13)) return year-1; return year; }
const MALE_START=1921, FEMALE_START=1922;
const MALE_SEQ=['ƒêo√†i','C√†n','Kh√¥n','T·ªën','Ch·∫•n','Kh√¥n','Kh·∫£m','Ly','C·∫•n']; const FEMALE_SEQ=['C·∫•n','Kh·∫£m','Ly','T·ªën','Ch·∫•n','Kh√¥n','C√†n','ƒêo√†i','C·∫•n']; const mod9=n=>((n%9)+9)%9;
function getCungMenh(birth,gender){
  const eff=getEffectiveBirthYear(birth);
  const idx=mod9(eff-(gender==='nam'?MALE_START:FEMALE_START));
  const cung=(gender==='nam'?MALE_SEQ:FEMALE_SEQ)[idx];
  const info={'C√†n':{nguyenTo:'Kim',huong:'T√¢y B·∫Øc'},'Kh√¥n':{nguyenTo:'Th·ªï',huong:'T√¢y Nam'},'C·∫•n':{nguyenTo:'Th·ªï',huong:'ƒê√¥ng B·∫Øc'},'Ch·∫•n':{nguyenTo:'M·ªôc',huong:'ƒê√¥ng'},'T·ªën':{nguyenTo:'M·ªôc',huong:'ƒê√¥ng Nam'},'Ly':{nguyenTo:'H·ªèa',huong:'Nam'},'Kh·∫£m':{nguyenTo:'Th·ªßy',huong:'B·∫Øc'},'ƒêo√†i':{nguyenTo:'Kim',huong:'T√¢y'}}[cung];
  const nhom=['Kh·∫£m','Ly','Ch·∫•n','T·ªën'].includes(cung)?'ƒê√¥ng T·ª© Tr·∫°ch':'T√¢y T·ª© Tr·∫°ch';
  return {effectiveYear:eff,cung,nhomTrach:nhom,...info};
}
function getBatTrachForCung(cung){
  const C={good:{'Sinh Kh√≠':{ten:'Sinh Kh√≠',loai:'good',y:'T√†i l·ªôc, thƒÉng ti·∫øn.'},'Thi√™n Y':{ten:'Thi√™n Y',loai:'good',y:'S·ª©c kh·ªèe, qu√Ω nh√¢n.'},'Di√™n Ni√™n':{ten:'Di√™n Ni√™n',loai:'good',y:'H√≤a thu·∫≠n.'},'Ph·ª•c V·ªã':{ten:'Ph·ª•c V·ªã',loai:'good',y:'·ªîn ƒë·ªãnh, h·ªçc h√†nh.'}},
           bad:{'Tuy·ªát M·ªánh':{ten:'Tuy·ªát M·ªánh',loai:'bad',y:'N·∫∑ng nh·∫•t.'},'Ng≈© Qu·ª∑':{ten:'Ng≈© Qu·ª∑',loai:'bad',y:'Th·ªã phi.'},'L·ª•c S√°t':{ten:'L·ª•c S√°t',loai:'bad',y:'Ki·ªán t·ª•ng.'},'H·ªça H·∫°i':{ten:'H·ªça H·∫°i',loai:'bad',y:'Xui x·∫ªo.'}}};
  const B={'Kh·∫£m':{'ƒê√¥ng Nam':C.good['Sinh Kh√≠'],'ƒê√¥ng':C.good['Thi√™n Y'],'Nam':C.good['Di√™n Ni√™n'],'B·∫Øc':C.good['Ph·ª•c V·ªã'],'T√¢y Nam':C.bad['Tuy·ªát M·ªánh'],'ƒê√¥ng B·∫Øc':C.bad['Ng≈© Qu·ª∑'],'T√¢y B·∫Øc':C.bad['L·ª•c S√°t'],'T√¢y':C.bad['H·ªça H·∫°i']},
           'Ly':{'ƒê√¥ng':C.good['Sinh Kh√≠'],'ƒê√¥ng Nam':C.good['Thi√™n Y'],'B·∫Øc':C.good['Di√™n Ni√™n'],'Nam':C.good['Ph·ª•c V·ªã'],'T√¢y B·∫Øc':C.bad['Tuy·ªát M·ªánh'],'T√¢y':C.bad['Ng≈© Qu·ª∑'],'T√¢y Nam':C.bad['L·ª•c S√°t'],'ƒê√¥ng B·∫Øc':C.bad['H·ªça H·∫°i']},
           'Ch·∫•n':{'Nam':C.good['Sinh Kh√≠'],'B·∫Øc':C.good['Thi√™n Y'],'ƒê√¥ng Nam':C.good['Di√™n Ni√™n'],'ƒê√¥ng':C.good['Ph·ª•c V·ªã'],'T√¢y':C.bad['Tuy·ªát M·ªánh'],'T√¢y B·∫Øc':C.bad['Ng≈© Qu·ª∑'],'ƒê√¥ng B·∫Øc':C.bad['L·ª•c S√°t'],'T√¢y Nam':C.bad['H·ªça H·∫°i']},
           'T·ªën':{'B·∫Øc':C.good['Sinh Kh√≠'],'Nam':C.good['Thi√™n Y'],'ƒê√¥ng':C.good['Di√™n Ni√™n'],'ƒê√¥ng Nam':C.good['Ph·ª•c V·ªã'],'ƒê√¥ng B·∫Øc':C.bad['Tuy·ªát M·ªánh'],'T√¢y Nam':C.bad['Ng≈© Qu·ª∑'],'T√¢y':C.bad['L·ª•c S√°t'],'T√¢y B·∫Øc':C.bad['H·ªça H·∫°i']},
           'C√†n':{'T√¢y':C.good['Sinh Kh√≠'],'ƒê√¥ng B·∫Øc':C.good['Thi√™n Y'],'T√¢y Nam':C.good['Di√™n Ni√™n'],'T√¢y B·∫Øc':C.good['Ph·ª•c V·ªã'],'Nam':C.bad['Tuy·ªát M·ªánh'],'ƒê√¥ng':C.bad['Ng≈© Qu·ª∑'],'B·∫Øc':C.bad['L·ª•c S√°t'],'ƒê√¥ng Nam':C.bad['H·ªça H·∫°i']},
           'Kh√¥n':{'ƒê√¥ng B·∫Øc':C.good['Sinh Kh√≠'],'T√¢y':C.good['Thi√™n Y'],'T√¢y B·∫Øc':C.good['Di√™n Ni√™n'],'T√¢y Nam':C.good['Ph·ª•c V·ªã'],'B·∫Øc':C.bad['Tuy·ªát M·ªánh'],'ƒê√¥ng Nam':C.bad['Ng≈© Qu·ª∑'],'Nam':C.bad['L·ª•c S√°t'],'ƒê√¥ng':C.bad['H·ªça H·∫°i']},
           'C·∫•n':{'T√¢y Nam':C.good['Sinh Kh√≠'],'T√¢y B·∫Øc':C.good['Thi√™n Y'],'T√¢y':C.good['Di√™n Ni√™n'],'ƒê√¥ng B·∫Øc':C.good['Ph·ª•c V·ªã'],'ƒê√¥ng Nam':C.bad['Tuy·ªát M·ªánh'],'B·∫Øc':C.bad['Ng≈© Qu·ª∑'],'ƒê√¥ng':C.bad['L·ª•c S√°t'],'Nam':C.bad['H·ªça H·∫°i']},
           'ƒêo√†i':{'T√¢y B·∫Øc':C.good['Sinh Kh√≠'],'T√¢y Nam':C.good['Thi√™n Y'],'ƒê√¥ng B·∫Øc':C.good['Di√™n Ni√™n'],'T√¢y':C.good['Ph·ª•c V·ªã'],'ƒê√¥ng':C.bad['Tuy·ªát M·ªánh'],'Nam':C.bad['Ng≈© Qu·ª∑'],'ƒê√¥ng Nam':C.bad['L·ª•c S√°t'],'B·∫Øc':C.bad['H·ªça H·∫°i']}};
  return B[cung];
}
function analyzeHouseDirection(cung,huong){ const t=getBatTrachForCung(cung); const all=Object.entries(t).map(([h,i])=>({huong:h,...i})); return {selected:t[huong],goods:all.filter(i=>i.loai==='good'),bads:all.filter(i=>i.loai==='bad')}; }
const ZODIAC=['T√Ω','S·ª≠u','D·∫ßn','M√£o','Th√¨n','T·ªµ','Ng·ªç','M√πi','Th√¢n','D·∫≠u','Tu·∫•t','H·ª£i']; const idxZ=y=>((y-4)%12+12)%12; const nameZ=y=>ZODIAC[idxZ(y)];
const TTG=[{group:['Th√¢n','T√Ω','Th√¨n'],tamTai:['D·∫ßn','M√£o','Th√¨n']},{group:['D·∫ßn','Ng·ªç','Tu·∫•t'],tamTai:['Th√¢n','D·∫≠u','Tu·∫•t']},{group:['H·ª£i','M√£o','M√πi'],tamTai:['T·ªµ','Ng·ªç','M√πi']},{group:['T·ªµ','D·∫≠u','S·ª≠u'],tamTai:['H·ª£i','T√Ω','S·ª≠u']}];
function tuoiMu(eff,year){return year-eff+1}
function checkKimLau(t){let r=t%9;if(r===0)r=9;const m={1:'Kim L√¢u Th√¢n',3:'Kim L√¢u Th√™',6:'Kim L√¢u T·ª≠',8:'Kim L√¢u L·ª•c S√∫c'};return {isKimLau:[1,3,6,8].includes(r),type:m[r]||null}}
function checkHoangOc(t){const lb=['Nh·∫•t C√°t','Nh√¨ Nghi','Tam ƒê·ªãa S√°t','T·ª© T·∫•n T√†i','Ng≈© Th·ªç T·ª≠','L·ª•c Hoang ·ªêc'];const m=t%6;const i=(m===0)?5:m-1;const n=lb[i];return {name:n,isBad:['Tam ƒê·ªãa S√°t','Ng≈© Th·ªç T·ª≠','L·ª•c Hoang ·ªêc'].includes(n)}}
function checkTamTai(ownerYear,year){const o=nameZ(ownerYear),c=nameZ(year),g=TTG.find(x=>x.group.includes(o));return {isTamTai:g?g.tamTai.includes(c):false,yearChi:c}}
function checkXungTuoi(ownerYear,year){const opp=(idxZ(ownerYear)+6)%12;return {isXung:idxZ(year)===opp,opp:ZODIAC[opp],yearChi:nameZ(year)}}
function elemYear(y){const s=((y-4)%10+10)%10; if(s===0||s===1)return'M·ªôc'; if(s===2||s===3)return'H·ªèa'; if(s===4||s===5)return'Th·ªï'; if(s===6||s===7)return'Kim'; return'Th·ªßy';}
const KHAC={'M·ªôc':'Th·ªï','Th·ªï':'Th·ªßy','Th·ªßy':'H·ªèa','H·ªèa':'Kim','Kim':'M·ªôc'};
function elemConflict(a,b){return a&&b&&(KHAC[a]===b||KHAC[b]===a)}
function evaluateBuildTime(birth,gender,year,month){
  const cung=getCungMenh(birth,gender); const age=tuoiMu(cung.effectiveYear,year);
  const kl=checkKimLau(age), ho=checkHoangOc(age), tt=checkTamTai(cung.effectiveYear,year), x=checkXungTuoi(cung.effectiveYear,year);
  const yE=elemYear(year), mE=[null,'Th·ªßy',null,'H·ªèa','Th·ªï','Kim','M·ªôc',null,'H·ªèa','Th·ªï','Kim','M·ªôc','Th·ªßy'][month]||null;
  const warnings=[]; if(kl.isKimLau)warnings.push(`Ph·∫°m Kim L√¢u (${kl.type}).`); if(ho.isBad)warnings.push(`Ph·∫°m Hoang ·ªêc (${ho.name}).`); if(tt.isTamTai)warnings.push(`Ph·∫°m Tam Tai (${tt.yearChi}).`); if(x.isXung)warnings.push(`Xung tu·ªïi v·ªõi nƒÉm ${year} (ƒë·ªëi xung ${x.opp}).`); if(elemConflict(cung.nguyenTo,yE))warnings.push(`Cung (${cung.nguyenTo}) kh·∫Øc Ng≈© h√†nh nƒÉm (${yE}).`);
  const monthWarnings=[]; if(elemConflict(cung.nguyenTo,mE))monthWarnings.push(`Th√°ng ${month} xung ng≈© h√†nh (${mE}) v·ªõi Cung (${cung.nguyenTo}).`);
  return {cung,ageMu:age,yearElement:yE,monthElement:mE,warnings,monthWarnings};
}

/* ====== UI: Wards theo t·ªânh, Issues, La b√†n, L∆∞u h·ªì s∆° ====== */
function populateWardsForProvince(){
  const prov=document.getElementById('bd-province').value;
  const sel=document.getElementById('bd-ward');
  const wards=(prov==='ƒê·ªìng Nai'?DN_WARDS_2025:BP_WARDS_2025);
  const opts=wards.map(w=>`<option value="${w}">${w}</option>`);
  opts.push('<option value="__other__">Kh√°c (nh·∫≠p tay)</option>');
  sel.innerHTML=opts.join('');
  sel.value=wards[0]||'__other__';
  document.getElementById('ward-custom-wrap').style.display = (sel.value==='__other__')?'block':'none';
  document.getElementById('bd-full-address').textContent = composeFullAddress();
}
function currentWardValue(){
  const v=document.getElementById('bd-ward').value;
  if(v==='__other__') return document.getElementById('bd-ward-custom').value.trim();
  return v;
}
function composeFullAddress(){
  const prov=document.getElementById('bd-province').value;
  const ward=currentWardValue();
  const detail=document.getElementById('bd-address-detail').value.trim();
  const parts=[]; if(detail)parts.push(detail); if(ward)parts.push(ward); parts.push(prov);
  return parts.join(', ');
}
function renderIssues(filter=''){
  const wrap=document.getElementById('issues-container'); if(!wrap) return;
  const f=(filter||'').toLowerCase();
  const list=ISSUES.filter(i=> (i.cat+' '+i.label).toLowerCase().includes(f));
  wrap.innerHTML=list.map(i=>`<label class="issue-item"><input type="checkbox" name="issue" value="${i.id}" onchange="updateSelectedIssues()"><span><strong>[${i.cat}]</strong> ${i.label}</span></label>`).join('');
}

function updateSelectedIssues(){
  const selectedIds = getSelectedIssues();
  const selectedWrap = document.getElementById('selected-issues');
  const selectedList = document.getElementById('selected-issues-list');
  
  if(selectedIds.length === 0){
    selectedWrap.classList.add('hidden');
    return;
  }
  
  selectedWrap.classList.remove('hidden');
  const map = new Map(ISSUES.map(i=>[i.id,i]));
  selectedList.innerHTML = selectedIds.map(id => {
    const issue = map.get(id);
    return `<span class="bg-feng-shui-green/10 text-feng-shui-green px-3 py-1 rounded-full text-sm border border-feng-shui-green/30">
      [${issue.cat}] ${issue.label}
      <button onclick="removeIssue('${id}')" class="ml-2 text-feng-shui-red hover:bg-feng-shui-red/10 rounded-full px-1">√ó</button>
    </span>`;
  }).join('');
}

function removeIssue(issueId){
  const checkbox = document.querySelector(`input[name="issue"][value="${issueId}"]`);
  if(checkbox) {
    checkbox.checked = false;
    updateSelectedIssues();
  }
}

function toggleIssuesList(){
  const detail = document.getElementById('issues-detail');
  const button = document.getElementById('toggle-issues-list');
  
  if(detail.classList.contains('hidden')){
    detail.classList.remove('hidden');
    button.textContent = 'üìã ·∫®n danh s√°ch';
    renderIssues(); // Render khi m·ªü
  } else {
    detail.classList.add('hidden');
    button.textContent = 'üìã Ch·ªçn v·∫•n ƒë·ªÅ m√¥i tr∆∞·ªùng & phong th·ªßy';
  }
}
function getSelectedIssues(){ return Array.from(document.querySelectorAll('input[name="issue"]:checked')).map(el=>el.value); }
function checkSiteIssues(ids){
  const problems=[],solutions=[]; const map=new Map(ISSUES.map(i=>[i.id,i]));
  ids.forEach(id=>{ const it=map.get(id); if(it){problems.push(`${it.label}: ${it.impact}`); solutions.push(`H√≥a gi·∫£i: ${it.remedy}`);} });
  return {problems,solutions};
}

const STORAGE_KEY='ptpro_profiles_wards2025';
const getProfiles=()=>JSON.parse(localStorage.getItem(STORAGE_KEY)||'[]');
const setProfiles=a=>localStorage.setItem(STORAGE_KEY,JSON.stringify(a));
const uuid=()=> (crypto?.randomUUID ? crypto.randomUUID() : 'id_'+Date.now()+Math.random().toString(16).slice(2));
function normalizePhone(p){ p=(p||'').replace(/[^\d+]/g,'').trim(); if(p.startsWith('+84'))return p; if(p.startsWith('0')&&p.length>=9)return '+84'+p.slice(1); return p; }
function isValidPhone(p){ p=normalizePhone(p); const vn=/^\+?84(3|5|7|8|9)\d{8}$/; const g=/^\+?\d{8,13}$/; return vn.test(p)||g.test(p); }

function gatherInputs(){
  const name=document.getElementById('kh-ten').value.trim();
  const phone=document.getElementById('kh-phone').value.trim();
  const birth=document.getElementById('ngay-sinh').value.trim();
  const gender=document.getElementById('gioi-tinh').value;
  const huong=document.getElementById('huong-nha').value;
  const yearX=parseInt(document.getElementById('nam-xay').value,10);
  const monthX=parseInt(document.getElementById('thang-xay').value,10);

  const province=document.getElementById('bd-province').value;
  const ward=currentWardValue();
  const to=document.getElementById('bd-to').value.trim();
  const thua=document.getElementById('bd-thua').value.trim();
  const price=parseFloat(document.getElementById('bd-price').value)||0;
  const detail=document.getElementById('bd-address-detail').value.trim();
  const note=document.getElementById('bd-note').value.trim();
  const issueIds=getSelectedIssues();

  const fullAddr=composeFullAddress();
  document.getElementById('bd-full-address').textContent=fullAddr||'‚Äî';

  const bds={province,ward,to,thua,addressDetail:detail,fullAddress:fullAddr,price,note};
  return {name,phone,birth,gender,huong,yearX,monthX,bds,issueIds};
}

async function renderResult(R,i){
  const dir=analyzeHouseDirection(R.cung.cung,i.huong);
  const site=checkSiteIssues(i.issueIds);
  let html='';
  html+=`<div class="ket-luan"><div><span class="badge">Cung m·ªánh</span> <strong>${R.cung.cung}</strong> ‚Äî Ng≈© h√†nh: <strong>${R.cung.nguyenTo}</strong> ‚Äî Nh√≥m: <strong>${R.cung.nhomTrach}</strong></div></div>`;
  html+=`<h3 class="block-title">H∆∞·ªõng nh√†: ${i.huong} <span class="tag ${dir.selected?.loai||'warn'}">${dir.selected?.ten||'‚Äî'}</span></h3>`;
  if(dir.selected){
    const adv = dir.selected.loai==='good'
      ? ['∆Øu ti√™n c·ª≠a/ban c√¥ng h∆∞·ªõng n√†y.','B·∫øp/gi∆∞·ªùng/b√†n th·ªù/b√†n l√†m vi·ªác xoay v·ªÅ 1 trong 4 h∆∞·ªõng t·ªët.','Gi·ªØ l·ªëi v√†o th√¥ng tho√°ng.']
      : ['B√¨nh phong/hi√™n/b·∫≠c tam c·∫•p ƒë·ªÉ ‚Äúb·∫ª‚Äù d√≤ng kh√≠ x·∫•u.','B·ªë tr√≠ ‚Äút·ªça hung ‚Äì h∆∞·ªõng c√°t‚Äù.','C√¢n nh·∫Øc B√°t Qu√°i l·ªìi.','TƒÉng c√¢y xanh/√°nh s√°ng.'];
    html+=`<p><em>√ù nghƒ©a:</em> ${dir.selected.y}</p><ul class="clean">`+adv.map(a=>`<li>${a}</li>`).join('')+`</ul>`;
  }
  if(dir.goods.length){
    const pr={'Sinh Kh√≠':1,'Thi√™n Y':2,'Di√™n Ni√™n':3,'Ph·ª•c V·ªã':4};
    const g=[...dir.goods].sort((a,b)=>(pr[a.ten]||9)-(pr[b.ten]||9));
    html+=`<p><strong>4 h∆∞·ªõng t·ªët n√™n ∆∞u ti√™n:</strong></p><ul class="clean">`+g.map(x=>`<li><span class="good">${x.huong}</span> ‚Äî ${x.ten}: ${x.y}</li>`).join('')+`</ul>`;
  }
  html+=`<hr/><h3 class="block-title">NƒÉm/Th√°ng x√¢y</h3>`;
  html+=`<p>Tu·ªïi m·ª•: <strong>${R.ageMu}</strong> ‚Äî Ng≈© h√†nh nƒÉm: <strong>${R.yearElement}</strong>${R.monthElement?` ‚Äî Ng≈© h√†nh th√°ng: <strong>${R.monthElement}</strong>`:''}</p>`;
  if(R.warnings.length===0) html+=`<p class="good">NƒÉm ${i.yearX}: Kh√¥ng th·∫•y c·∫£nh b√°o l·ªõn.</p>`; else html+=`<ul class="clean">`+R.warnings.map(w=>`<li class="bad">${w}</li>`).join('')+`</ul>`;
  if(R.monthWarnings.length===0) html+=`<p class="good">Th√°ng ${i.monthX}: Kh√¥ng th·∫•y c·∫£nh b√°o l·ªõn.</p>`; else html+=`<ul class="clean">`+R.monthWarnings.map(w=>`<li class="warn">${w}</li>`).join('')+`</ul>`;

  html+=`<hr/><h3 class="block-title">M√¥i tr∆∞·ªùng & l·ªói phong th·ªßy</h3>`;
  if(site.problems.length===0) html+=`<p class="good">Kh√¥ng ph√°t hi·ªán l·ªói ƒë√£ ch·ªçn.</p>`;
  else{ html+=`<p><strong>V·∫•n ƒë·ªÅ:</strong></p><ul class="clean">`+site.problems.map(p=>`<li class="bad">${p}</li>`).join('')+`</ul>`;
        html+=`<p><strong>H√≥a gi·∫£i:</strong></p><ul class="clean">`+site.solutions.map(s=>`<li>${s}</li>`).join('')+`</ul>`; }

  html+=`<hr/><h3 class="block-title">Th√¥ng tin b·∫•t ƒë·ªông s·∫£n</h3>`;
  html+=`<p><strong>ƒê·ªãa ch·ªâ:</strong> ${i.bds.fullAddress||'‚Äî'}</p>`;
  html+=`<p><strong>T·ªù/Th·ª≠a:</strong> ${i.bds.to||'‚Äî'} / ${i.bds.thua||'‚Äî'}</p>`;
  html+=`<p><strong>Gi√°:</strong> ${i.bds.price?new Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND'}).format(i.bds.price):'‚Äî'}</p>`;
  html+=`<p><strong>Ghi ch√∫:</strong> ${i.bds.note||'‚Äî'}</p>`;
  html+=`<hr/><h3 class="block-title">Ph√¢n t√≠ch AI</h3><div id="ai-analysis"><em>ƒêang ph√¢n t√≠ch‚Ä¶</em></div>`;
  document.getElementById('result-content').innerHTML=html;
  try {
    const ai = await getAiAnalysis({input:i, result:R});
    document.getElementById('ai-analysis').textContent = ai.text || 'Kh√¥ng c√≥ ph·∫£n h·ªìi';
  } catch(err) {
    document.getElementById('ai-analysis').textContent = 'L·ªói AI: ' + (err.message || err);
  }
}

async function getAiAnalysis(payload){
  const res = await fetch('/api/ai-analyze', {
    method: 'POST',
    headers: {'Content-Type':'application/json'},
    body: JSON.stringify(payload)
  });
  if(!res.ok) throw new Error('Network error');
  return res.json();
}

function saveProfile(currentResult){
  const i=gatherInputs();
  if(!i.name) return alert('Vui l√≤ng nh·∫≠p h·ªç t√™n.');
  if(!i.phone) return alert('Vui l√≤ng nh·∫≠p SƒêT.');
  if(!isValidPhone(i.phone)) return alert('SƒêT ch∆∞a ƒë√∫ng ƒë·ªãnh d·∫°ng.');
  if(!i.birth) return alert('Vui l√≤ng nh·∫≠p ng√†y sinh.');
  if(!i.yearX||i.yearX<1900||i.yearX>2099) return alert('NƒÉm x√¢y kh√¥ng h·ª£p l·ªá.');
  if(!i.monthX||i.monthX<1||i.monthX>12) return alert('Th√°ng x√¢y kh√¥ng h·ª£p l·ªá.');
  const R=currentResult||evaluateBuildTime(i.birth,i.gender,i.yearX,i.monthX);
  const list=getProfiles(); const phoneKey=normalizePhone(i.phone); const idx=list.findIndex(p=>p.customer.phoneKey===phoneKey);
  const profile={
    id:idx>=0?list[idx].id:uuid(),
    createdAt:idx>=0?list[idx].createdAt:new Date().toISOString(),
    updatedAt:new Date().toISOString(),
    customer:{name:i.name,phone:i.phone,phoneKey},
    input:{birth:i.birth,gender:i.gender,huong:i.huong,year:i.yearX,month:i.monthX,issueIds:i.issueIds},
    bds:i.bds,
    result:R,
    summary:{cung:R.cung.cung,menh:R.cung.nguyenTo,nhom:R.cung.nhomTrach,dir:i.huong,fullAddress:i.bds.fullAddress,to:i.bds.to,thua:i.bds.thua,price:i.bds.price,issues:i.issueIds.length}
  };
  if(idx>=0) list[idx]=profile; else list.unshift(profile);
  setProfiles(list); renderProfiles(); alert('ƒê√£ l∆∞u h·ªì s∆°.');
}

function renderProfiles(filter=''){
  const tbody=document.getElementById('profiles-tbody');
  const list=getProfiles().filter(p=> (p.customer.name+' '+p.customer.phone).toLowerCase().includes((filter||'').toLowerCase()) );
  const fmt=s=>new Date(s).toLocaleString();
  tbody.innerHTML=list.map(p=>`
    <tr data-id="${p.id}">
      <td>${p.customer.name}</td>
      <td>${p.customer.phone}</td>
      <td>${p.summary.cung} (${p.summary.menh})</td>
      <td>${p.summary.dir}</td>
      <td>${p.summary.fullAddress||''}</td>
      <td>${(p.summary.to||'')}${p.summary.thua?(' / '+p.summary.thua):''}</td>
      <td>${p.summary.price?new Intl.NumberFormat('vi-VN',{style:'currency',currency:'VND'}).format(p.summary.price):''}</td>
      <td>${p.summary.issues||0}</td>
      <td>${fmt(p.createdAt)}</td>
      <td class="row-actions"><button class="view">Xem</button><button class="delete">X√≥a</button></td>
    </tr>`).join('');
}

function exportCSV(){
  const rows=getProfiles(); if(rows.length===0) return alert('Ch∆∞a c√≥ d·ªØ li·ªáu ƒë·ªÉ xu·∫•t.');
  const header=['id','name','phone','birth','gender','huong','year','month','cung','menh','nhom','address','ward','province','to','thua','price','issues','note','createdAt'];
  const csv=[header.join(',')];
  rows.forEach(p=>{
    const b=p.bds||{};
    const r=[p.id,`"${(p.customer.name||'').replace(/"/g,'""')}"`,p.customer.phone,p.input.birth,p.input.gender,p.input.huong,p.input.year,p.input.month,
      p.result?.cung?.cung||'',p.result?.cung?.nguyenTo||'',p.result?.cung?.nhomTrach||'',
      b.fullAddress||'',b.ward||'',b.province||'',b.to||'',b.thua||'',b.price||'',(p.input.issueIds||[]).length,(b.note||'').replace(/,/g,';'),p.createdAt];
    csv.push(r.join(','));
  });
  const blob=new Blob([csv.join('\n')],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='ho_so_khach_bds.csv'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
}

/* ====== S·ª± ki·ªán UI ====== */
document.addEventListener('DOMContentLoaded', ()=>{
  // Province -> Wards
  document.getElementById('bd-province').addEventListener('change',populateWardsForProvince);
  populateWardsForProvince();

  document.getElementById('bd-ward').addEventListener('change',e=>{
    document.getElementById('ward-custom-wrap').style.display = (e.target.value==='__other__')?'block':'none';
    document.getElementById('bd-full-address').textContent = composeFullAddress();
  });
  ['bd-ward-custom','bd-address-detail','bd-to','bd-thua','bd-price','bd-note'].forEach(id=>{
    const el=document.getElementById(id); el.addEventListener('input',()=>{ document.getElementById('bd-full-address').textContent=composeFullAddress(); });
  });
  document.getElementById('btn-save-ward').addEventListener('click',()=>{
    const prov=document.getElementById('bd-province').value;
    const custom=document.getElementById('bd-ward-custom').value.trim();
    if(!custom) return alert('Nh·∫≠p t√™n ph∆∞·ªùng/x√£.');
    // L∆∞u b·ªï sung t·∫°m th·ªùi v√†o danh s√°ch c·ªßa t·ªânh hi·ªán t·∫°i
    if(prov==='ƒê·ªìng Nai') DN_WARDS_2025.push(custom); else BP_WARDS_2025.push(custom);
    populateWardsForProvince();
    document.getElementById('bd-ward').value=custom;
    document.getElementById('ward-custom-wrap').style.display='none';
    document.getElementById('bd-full-address').textContent=composeFullAddress();
    alert('ƒê√£ l∆∞u ph∆∞·ªùng/x√£ m·ªõi v√†o danh s√°ch c·ª•c b·ªô.');
  });

  // Issues
  document.getElementById('issues-search').addEventListener('input',e=>renderIssues(e.target.value));
  document.getElementById('toggle-issues-list').addEventListener('click', toggleIssuesList);

  // Compass
  document.getElementById('btn-compass-start').addEventListener('click',startCompass);
  document.getElementById('btn-compass-stop').addEventListener('click',stopCompass);
  document.getElementById('btn-compass-apply').addEventListener('click',applyCompassToDirection);

  // Profiles
  renderProfiles();
  document.getElementById('profiles-search').addEventListener('input',e=>renderProfiles(e.target.value));

  // Analyze
  document.getElementById('btn-analyze').addEventListener('click',async()=>{
    try{
      const i=gatherInputs();
      if(!i.birth) return alert('Vui l√≤ng nh·∫≠p ng√†y sinh.');
      if(!i.yearX||i.yearX<1900||i.yearX>2099) return alert('NƒÉm x√¢y kh√¥ng h·ª£p l·ªá.');
      if(!i.monthX||i.monthX<1||i.monthX>12) return alert('Th√°ng x√¢y kh√¥ng h·ª£p l·ªá.');
      const R=evaluateBuildTime(i.birth,i.gender,i.yearX,i.monthX);
      await renderResult(R,i);
    }catch(err){ alert('L·ªói: '+(err.message||err)); }
  });

  // Save / Export
  document.getElementById('btn-save').addEventListener('click',()=>{ try{ saveProfile(); }catch(err){ alert('L·ªói: '+(err.message||err)); }});
  document.getElementById('btn-export').addEventListener('click',exportCSV);

  // Numerology
  document.getElementById('btn-numerology').addEventListener('click', analyzeNumerologyClick);
  document.getElementById('btn-compatibility').addEventListener('click', analyzeCompatibilityClick);
  
  // New numerology analysis event listeners
  document.getElementById('btn-name-analysis')?.addEventListener('click', analyzeName);
  document.getElementById('btn-phone-analysis')?.addEventListener('click', analyzePhone);
  document.getElementById('btn-number-compatibility')?.addEventListener('click', checkNumberCompatibility);

  // Row actions
  document.getElementById('profiles-tbody').addEventListener('click',e=>{
    const tr=e.target.closest('tr'); if(!tr) return; const id=tr.getAttribute('data-id');
    const list=getProfiles(); const p=list.find(x=>x.id===id); if(!p) return;
    if(e.target.classList.contains('view')){
      // fill form
      document.getElementById('kh-ten').value=p.customer.name;
      document.getElementById('kh-phone').value=p.customer.phone;
      document.getElementById('ngay-sinh').value=p.input.birth;
      document.getElementById('gioi-tinh').value=p.input.gender;
      document.getElementById('huong-nha').value=p.input.huong;
      document.getElementById('nam-xay').value=p.input.year;
      document.getElementById('thang-xay').value=p.input.month;

      document.getElementById('bd-province').value=p.bds.province||'ƒê·ªìng Nai';
      populateWardsForProvince();
      const wards=(p.bds.province==='B√¨nh Ph∆∞·ªõc'?BP_WARDS_2025:DN_WARDS_2025);
      if(wards.includes(p.bds.ward)){ document.getElementById('bd-ward').value=p.bds.ward; document.getElementById('ward-custom-wrap').style.display='none'; }
      else { document.getElementById('bd-ward').value='__other__'; document.getElementById('ward-custom-wrap').style.display='block'; document.getElementById('bd-ward-custom').value=p.bds.ward||''; }
      document.getElementById('bd-to').value=p.bds.to||'';
      document.getElementById('bd-thua').value=p.bds.thua||'';
      document.getElementById('bd-address-detail').value=p.bds.addressDetail||'';
      document.getElementById('bd-price').value=p.bds.price||'';
      document.getElementById('bd-note').value=p.bds.note||'';
      document.getElementById('bd-full-address').textContent=p.bds.fullAddress||'‚Äî';

      // tick l·∫°i issues
      renderIssues(document.getElementById('issues-search').value||'');
      const set=new Set(p.input.issueIds||[]);
      document.querySelectorAll('input[name="issue"]').forEach(cb=> cb.checked=set.has(cb.value));
      updateSelectedIssues(); // C·∫≠p nh·∫≠t hi·ªÉn th·ªã c√°c m·ª•c ƒë√£ ch·ªçn

      renderResult(p.result,{...p.input,bds:p.bds,issueIds:p.input.issueIds||[]});
      window.scrollTo({top:0,behavior:'smooth'});
    }
    if(e.target.classList.contains('delete')){
      if(confirm('X√≥a h·ªì s∆° n√†y?')){ setProfiles(list.filter(x=>x.id!==id)); renderProfiles(document.getElementById('profiles-search').value); }
    }
  });
});

/* ====== TH·∫¶N S·ªê H·ªåC FUNCTIONS ====== */
// Helper function ƒë·ªÉ parse ng√†y sinh
function parseBirthDate(dateString) {
  if (!dateString) return null;
  
  // Lo·∫°i b·ªè kho·∫£ng tr·∫Øng
  dateString = dateString.trim();
  
  // Ki·ªÉm tra ƒë·ªãnh d·∫°ng DD/MM/YYYY
  if (dateString.match(/^\d{1,2}\/\d{1,2}\/\d{4}$/)) {
    const parts = dateString.split('/');
    return `${parts[2]}-${parts[1].padStart(2, '0')}-${parts[0].padStart(2, '0')}`;
  }
  
  // Ki·ªÉm tra ƒë·ªãnh d·∫°ng YYYY-MM-DD
  if (dateString.match(/^\d{4}-\d{1,2}-\d{1,2}$/)) {
    return dateString;
  }
  
  return dateString; // Tr·∫£ v·ªÅ nguy√™n g·ªëc n·∫øu kh√¥ng match
}

function analyzeNumerologyClick() {
  try {
    const name = document.getElementById('kh-ten').value.trim();
    const birth = document.getElementById('ngay-sinh').value.trim();
    
    console.log('Analyzing numerology for:', {name, birth});
    
    if (!name) return alert('Vui l√≤ng nh·∫≠p h·ªç t√™n.');
    if (!birth) return alert('Vui l√≤ng nh·∫≠p ng√†y sinh.');
    
    // Parse ng√†y sinh ƒë√∫ng format
    const parsedBirth = parseBirthDate(birth);
    console.log('Parsed birth date:', parsedBirth);
    
    const analysis = analyzeNumerology(name, parsedBirth);
    console.log('Analysis result:', analysis);
    if (!analysis) return alert('L·ªói khi ph√¢n t√≠ch th·∫ßn s·ªë h·ªçc.');
    
    displayNumerologyResult(analysis);
    
    // Ph√¢n t√≠ch s·ªë ƒëi·ªán tho·∫°i n·∫øu c√≥
    const phone = document.getElementById('kh-phone').value.trim();
    if (phone && isValidPhone(phone)) {
      analyzePhoneInNumerology();
    }
    
    document.getElementById('numerology-section').style.display = 'block';
    document.getElementById('numerology-section').scrollIntoView({ behavior: 'smooth' });
    
  } catch (err) {
    console.error('Error in analyzeNumerologyClick:', err);
    alert('L·ªói: ' + (err.message || err));
  }
}

function analyzeCompatibilityClick() {
  try {
    const partnerName = document.getElementById('partner-name').value.trim();
    const partnerBirth = document.getElementById('partner-birth').value.trim();
    const userBirth = document.getElementById('ngay-sinh').value.trim();
    
    if (!partnerName) return alert('Vui l√≤ng nh·∫≠p t√™n b·∫°n ƒë·ªùi.');
    if (!partnerBirth) return alert('Vui l√≤ng nh·∫≠p ng√†y sinh b·∫°n ƒë·ªùi.');
    if (!userBirth) return alert('Vui l√≤ng nh·∫≠p ng√†y sinh c·ªßa b·∫°n tr∆∞·ªõc.');
    
    const userLifePath = calculateLifePath(userBirth);
    const partnerLifePath = calculateLifePath(partnerBirth);
    const compatibility = analyzeCompatibility(userLifePath, partnerLifePath);
    
    displayCompatibilityResult(userLifePath, partnerLifePath, compatibility);
    
  } catch (err) {
    alert('L·ªói: ' + (err.message || err));
  }
}

function displayNumerologyResult(analysis) {
  console.log('displayNumerologyResult called with:', analysis);
  
  // Life Path
  const lifePathEl = document.getElementById('life-path-result');
  const lifePathNum = document.getElementById('life-path-number');
  lifePathNum.textContent = analysis.lifePath.number;
  lifePathEl.innerHTML = formatNumberMeaning(analysis.lifePath.meaning);
  
  // Expression
  const expressionEl = document.getElementById('expression-result');
  const expressionNum = document.getElementById('expression-number');
  expressionNum.textContent = analysis.expression.number;
  expressionEl.innerHTML = formatNumberMeaning(analysis.expression.meaning);
  
  // Soul
  const soulEl = document.getElementById('soul-result');
  const soulNum = document.getElementById('soul-number');
  soulNum.textContent = analysis.soul.number;
  soulEl.innerHTML = formatNumberMeaning(analysis.soul.meaning);
  
  // Personality
  const personalityEl = document.getElementById('personality-result');
  const personalityNum = document.getElementById('personality-number');
  personalityNum.textContent = analysis.personality.number;
  personalityEl.innerHTML = formatNumberMeaning(analysis.personality.meaning);
  
  // Personal Year
  const personalYearEl = document.getElementById('personal-year-result');
  const personalYearNum = document.getElementById('personal-year-number');
  console.log('Personal Year data:', analysis.personalYear);
  
  if (personalYearEl && personalYearNum) {
    // ƒê·∫£m b·∫£o c√≥ s·ªë h·ª£p l·ªá
    const yearNumber = analysis.personalYear.number;
    if (yearNumber && !isNaN(yearNumber)) {
      personalYearNum.textContent = yearNumber;
      personalYearEl.innerHTML = formatPersonalYearMeaning(analysis.personalYear.meaning);
    } else {
      personalYearNum.textContent = '1';
      personalYearEl.innerHTML = '<p><strong>L·ªói:</strong> Kh√¥ng th·ªÉ t√≠nh to√°n nƒÉm c√° nh√¢n. Vui l√≤ng ki·ªÉm tra ƒë·ªãnh d·∫°ng ng√†y sinh.</p>';
    }
  } else {
    console.error('Personal Year elements not found');
  }
}

function formatNumberMeaning(meaning) {
  if (!meaning || !meaning.title) return '<p>Ch∆∞a c√≥ th√¥ng tin</p>';
  
  let html = `<h4>${meaning.title}</h4>`;
  if (meaning.subtitle) html += `<p class="subtitle"><em>${meaning.subtitle}</em></p>`;
  
  html += `<p><strong>T√≠nh c√°ch:</strong> ${meaning.personality}</p>`;
  
  if (meaning.deep_traits) {
    html += `<div class="deep-traits">`;
    html += `<p><strong>B·∫£n ch·∫•t c·ªët l√µi:</strong> ${meaning.deep_traits.core_essence}</p>`;
    html += `<p><strong>S·ª© m·ªánh cu·ªôc ƒë·ªùi:</strong> ${meaning.deep_traits.life_mission}</p>`;
    if (meaning.deep_traits.spiritual_lesson) {
      html += `<p><strong>B√†i h·ªçc t√¢m linh:</strong> ${meaning.deep_traits.spiritual_lesson}</p>`;
    }
    html += `</div>`;
  }
  
  if (meaning.strengths && meaning.strengths.length > 0) {
    html += `<p><strong>ƒêi·ªÉm m·∫°nh:</strong></p>`;
    html += `<ul class="strength-list">`;
    meaning.strengths.slice(0, 6).forEach(strength => {
      html += `<li>${strength}</li>`;
    });
    html += `</ul>`;
  }
  
  if (meaning.weaknesses && meaning.weaknesses.length > 0) {
    html += `<p><strong>ƒêi·ªÉm y·∫øu c·∫ßn kh·∫Øc ph·ª•c:</strong></p>`;
    html += `<ul class="weakness-list">`;
    meaning.weaknesses.slice(0, 6).forEach(weakness => {
      html += `<li>${weakness}</li>`;
    });
    html += `</ul>`;
  }
  
  if (meaning.career_detailed) {
    html += `<p><strong>Ngh·ªÅ nghi·ªáp ph√π h·ª£p nh·∫•t:</strong> ${meaning.career_detailed.best_careers.slice(0, 4).join(', ')}</p>`;
    html += `<p><strong>Phong c√°ch l√†m vi·ªác:</strong> ${meaning.career_detailed.work_style}</p>`;
  } else if (meaning.career) {
    html += `<p><strong>Ngh·ªÅ nghi·ªáp ph√π h·ª£p:</strong> ${meaning.career}</p>`;
  }
  
  if (meaning.love_relationships) {
    html += `<p><strong>Phong c√°ch y√™u:</strong> ${meaning.love_relationships.love_style}</p>`;
    html += `<p><strong>L·ªùi khuy√™n t√¨nh y√™u:</strong> ${meaning.love_relationships.marriage_advice}</p>`;
  } else if (meaning.love) {
    html += `<p><strong>T√¨nh y√™u:</strong> ${meaning.love}</p>`;
  }
  
  if (meaning.health_tendencies) {
    html += `<p><strong>Xu h∆∞·ªõng s·ª©c kh·ªèe:</strong> C·∫ßn ch√∫ √Ω ${meaning.health_tendencies.physical.slice(0, 2).join(', ')}</p>`;
    html += `<p><strong>Ph∆∞∆°ng ph√°p ch·ªØa l√†nh:</strong> ${meaning.health_tendencies.healing_methods.slice(0, 2).join(', ')}</p>`;
  }
  
  if (meaning.lucky_numbers && meaning.lucky_numbers.length > 0) {
    html += `<p><strong>S·ªë may m·∫Øn:</strong> ${meaning.lucky_numbers.slice(0, 4).join(', ')}</p>`;
  }
  
  if (meaning.lucky_colors && meaning.lucky_colors.length > 0) {
    html += `<p><strong>M√†u may m·∫Øn:</strong></p>`;
    html += `<div class="lucky-colors">`;
    meaning.lucky_colors.forEach(color => {
      const colorCode = getColorCode(color);
      html += `<span class="color-box" style="background-color: ${colorCode}" title="${color}"></span>`;
    });
    html += `</div>`;
  }
  
  if (meaning.lucky_stones && meaning.lucky_stones.length > 0) {
    html += `<p><strong>ƒê√° may m·∫Øn:</strong> ${meaning.lucky_stones.slice(0, 3).join(', ')}</p>`;
  }
  
  if (meaning.lucky_days && meaning.lucky_days.length > 0) {
    html += `<p><strong>Ng√†y may m·∫Øn:</strong> ${meaning.lucky_days.join(', ')}</p>`;
  }
  
  if (meaning.life_purpose) {
    html += `<p><strong>M·ª•c ƒë√≠ch cu·ªôc ƒë·ªùi:</strong> <em>${meaning.life_purpose}</em></p>`;
  }
  
  if (meaning.advice) {
    html += `<p><strong>L·ªùi khuy√™n:</strong> ${meaning.advice}</p>`;
  }
  
  if (meaning.meditation_mantra) {
    html += `<p><strong>C√¢u th·∫ßn ch√∫:</strong> <em>"${meaning.meditation_mantra}"</em></p>`;
  }
  
  return html;
}

function getColorCode(colorName) {
  const colors = {
    'ƒê·ªè': '#e74c3c',
    'Cam': '#f39c12',
    'V√†ng': '#f1c40f',
    'Xanh l√°': '#27ae60',
    'Xanh d∆∞∆°ng': '#3498db',
    'Xanh d∆∞∆°ng ƒë·∫≠m': '#2c3e50',
    'T√≠m': '#9b59b6',
    'H·ªìng': '#e91e63',
    'N√¢u': '#8d6e63',
    'X√°m': '#95a5a6',
    'ƒêen': '#2c3e50',
    'Tr·∫Øng': '#ecf0f1',
    'B·∫°c': '#bdc3c7',
    'V√†ng nh·∫°t': '#f7dc6f',
    'V√†ng th√°nh': '#ffd700',
    'Xanh l·ª•c': '#52c41a',
    'T√≠m th√°nh': '#722ed1',
    'ƒê·ªè ƒë·∫≠m': '#a0393a',
    'Xanh ƒë·∫≠m': '#1f4e79',
    'N√¢u ƒë·∫≠m': '#5d4037'
  };
  return colors[colorName] || '#95a5a6';
}

// Test function ƒë·ªÉ debug
window.testPersonalYear = function() {
  const testData = {
    number: 1,
    meaning: {
      title: "NƒÉm Kh·ªüi ƒê·∫ßu M·ªõi (New Beginnings)",
      energy: "NƒÉng l∆∞·ª£ng kh·ªüi ƒë·∫ßu v√† independence",
      themes: ["B·∫Øt ƒë·∫ßu m·ªõi", "ƒê·ªôc l·∫≠p", "L√£nh ƒë·∫°o", "S√°ng t·∫°o"],
      opportunities: [
        "Kh·ªüi nghi·ªáp ho·∫∑c b·∫Øt ƒë·∫ßu d·ª± √°n m·ªõi",
        "Thay ƒë·ªïi career direction",
        "Ph√°t tri·ªÉn leadership skills",
        "T·∫°o d·ª±ng identity m·ªõi"
      ],
      challenges: [
        "√Åp l·ª±c t·ª´ vi·ªác ph·∫£i quy·∫øt ƒë·ªãnh",
        "C·∫£m gi√°c c√¥ ƒë∆°n khi pioneering",
        "Thi·∫øu ki√™n nh·∫´n v·ªõi qu√° tr√¨nh"
      ],
      advice: "ƒê√¢y l√† th·ªùi ƒëi·ªÉm tuy·ªát v·ªùi ƒë·ªÉ b·∫Øt ƒë·∫ßu nh·ªØng ƒëi·ªÅu m·ªõi. H√£y tin t∆∞·ªüng v√†o b·∫£n th√¢n v√† kh√¥ng s·ª£ ƒëi ƒë·∫ßu.",
      career_focus: "Kh·ªüi nghi·ªáp, promotion, new position, independent projects",
      relationship_focus: "New relationships, independence trong existing relationships",
      health_focus: "B·∫Øt ƒë·∫ßu fitness routine m·ªõi, energy high",
      financial_focus: "ƒê·∫ßu t∆∞ v√†o b·∫£n th√¢n, seed money cho ventures m·ªõi",
      lucky_months: ["Th√°ng 1", "Th√°ng 10"],
      avoid: "Ph·ª• thu·ªôc qu√° nhi·ªÅu v√†o ng∆∞·ªùi kh√°c, procrastination"
    }
  };
  
  const personalYearEl = document.getElementById('personal-year-result');
  const personalYearNum = document.getElementById('personal-year-number');
  
  if (personalYearEl && personalYearNum) {
    personalYearNum.textContent = testData.number;
    personalYearEl.innerHTML = formatPersonalYearMeaning(testData.meaning);
    document.getElementById('numerology-section').style.display = 'block';
    console.log('Test completed - check the display');
    alert('Test th√†nh c√¥ng! Ki·ªÉm tra √¥ "NƒÉm c√° nh√¢n 2025"');
  } else {
    console.error('Elements not found:', {personalYearEl, personalYearNum});
    alert('Kh√¥ng t√¨m th·∫•y elements. Ki·ªÉm tra HTML structure.');
  }
};

function formatPersonalYearMeaning(meaning) {
  console.log('formatPersonalYearMeaning called with:', meaning);
  
  if (!meaning) {
    return `<p><strong>√ù nghƒ©a nƒÉm 2025:</strong> Ch∆∞a c√≥ th√¥ng tin</p>`;
  }
  
  if (typeof meaning === 'string') {
    return `<p><strong>√ù nghƒ©a nƒÉm 2025:</strong> ${meaning}</p>`;
  }
  
  let html = `<div class="personal-year-analysis">`;
  
  // Title v√† subtitle
  if (meaning.title) {
    html += `<h4>${meaning.title}</h4>`;
  }
  if (meaning.subtitle) {
    html += `<p class="subtitle"><em>${meaning.subtitle}</em></p>`;
  }
  
  // Universal vibration
  if (meaning.universal_vibration) {
    html += `<div class="vibration-info">`;
    html += `<p><strong>üåü Dao ƒë·ªông v≈© tr·ª•:</strong> ${meaning.universal_vibration}</p>`;
    html += `</div>`;
  }
  
  // Energy
  if (meaning.energy) {
    html += `<p><strong>‚ö° NƒÉng l∆∞·ª£ng ch·ªß ƒë·∫°o:</strong> ${meaning.energy}</p>`;
  }
  
  // Birth day v√† month analysis
  if (meaning.birth_day_analysis) {
    html += `<div class="birth-analysis">`;
    html += `<p><strong>üìÖ ·∫¢nh h∆∞·ªüng ng√†y sinh:</strong> ${meaning.birth_day_analysis}</p>`;
    html += `</div>`;
  }
  
  if (meaning.birth_month_analysis) {
    html += `<div class="birth-analysis">`;
    html += `<p><strong>üìÖ ·∫¢nh h∆∞·ªüng th√°ng sinh:</strong> ${meaning.birth_month_analysis}</p>`;
    html += `</div>`;
  }
  
  // Themes
  if (meaning.themes && Array.isArray(meaning.themes) && meaning.themes.length > 0) {
    html += `<p><strong>üéØ Ch·ªß ƒë·ªÅ nƒÉm 2025:</strong> ${meaning.themes.join(', ')}</p>`;
  }
  
  // Opportunities
  if (meaning.opportunities && Array.isArray(meaning.opportunities) && meaning.opportunities.length > 0) {
    html += `<div class="opportunities">`;
    html += `<p><strong>üåü C∆° h·ªôi v√†ng trong nƒÉm 2025:</strong></p>`;
    html += `<ul>`;
    meaning.opportunities.slice(0, 5).forEach(opp => {
      html += `<li>${opp}</li>`;
    });
    html += `</ul>`;
    html += `</div>`;
  }
  
  // Challenges
  if (meaning.challenges && Array.isArray(meaning.challenges) && meaning.challenges.length > 0) {
    html += `<div class="challenges">`;
    html += `<p><strong>‚ö†Ô∏è Th√°ch th·ª©c c·∫ßn l∆∞u √Ω:</strong></p>`;
    html += `<ul>`;
    meaning.challenges.slice(0, 4).forEach(challenge => {
      html += `<li>${challenge}</li>`;
    });
    html += `</ul>`;
    html += `</div>`;
  }
  
  // Life lesson
  if (meaning.life_lesson) {
    html += `<div class="life-lesson">`;
    html += `<p><strong>üíé B√†i h·ªçc cu·ªôc ƒë·ªùi:</strong> ${meaning.life_lesson}</p>`;
    html += `</div>`;
  }
  
  // Advice
  if (meaning.advice) {
    html += `<div class="advice-box">`;
    html += `<p><strong>üí° L·ªùi khuy√™n cho nƒÉm 2025:</strong> ${meaning.advice}</p>`;
    html += `</div>`;
  }
  
  // Career, relationship, health, financial focus
  const focusAreas = [
    { key: 'career_focus', label: 'üíº T·∫≠p trung s·ª± nghi·ªáp', icon: 'üíº' },
    { key: 'relationship_focus', label: '‚ù§Ô∏è T√¨nh c·∫£m v√† m·ªëi quan h·ªá', icon: '‚ù§Ô∏è' },
    { key: 'health_focus', label: 'üè• S·ª©c kh·ªèe', icon: 'üè•' },
    { key: 'financial_focus', label: 'üí∞ T√†i ch√≠nh', icon: 'üí∞' },
    { key: 'spiritual_focus', label: 'üôè T√¢m linh', icon: 'üôè' }
  ];
  
  focusAreas.forEach(area => {
    if (meaning[area.key]) {
      html += `<p><strong>${area.label}:</strong> ${meaning[area.key]}</p>`;
    }
  });
  
  // Lucky elements
  if (meaning.lucky_colors && Array.isArray(meaning.lucky_colors) && meaning.lucky_colors.length > 0) {
    html += `<p><strong>üé® M√†u may m·∫Øn:</strong></p>`;
    html += `<div class="lucky-colors">`;
    meaning.lucky_colors.forEach(color => {
      const colorCode = getColorCode(color);
      html += `<span class="color-box" style="background-color: ${colorCode}" title="${color}"></span>`;
    });
    html += `</div>`;
  }
  
  if (meaning.lucky_numbers && Array.isArray(meaning.lucky_numbers) && meaning.lucky_numbers.length > 0) {
    html += `<p><strong>üî¢ S·ªë may m·∫Øn:</strong> ${meaning.lucky_numbers.join(', ')}</p>`;
  }
  
  if (meaning.lucky_months && Array.isArray(meaning.lucky_months) && meaning.lucky_months.length > 0) {
    html += `<p><strong>üìÖ Th√°ng may m·∫Øn nh·∫•t:</strong> ${meaning.lucky_months.join(', ')}</p>`;
  }
  
  // Soul purpose
  if (meaning.soul_purpose) {
    html += `<div class="soul-purpose">`;
    html += `<p><strong>üåü S·ª© m·ªánh t√¢m h·ªìn:</strong> <em>${meaning.soul_purpose}</em></p>`;
    html += `</div>`;
  }
  
  // Ancient wisdom
  if (meaning.ancient_wisdom) {
    html += `<div class="ancient-wisdom">`;
    html += `<p><strong>üìú Tr√≠ tu·ªá c·ªï ƒë·∫°i:</strong> <em>"${meaning.ancient_wisdom}"</em></p>`;
    html += `</div>`;
  }
  
  // What to avoid
  if (meaning.avoid) {
    html += `<div class="avoid-section">`;
    html += `<p><strong>üö´ N√™n tr√°nh:</strong> ${meaning.avoid}</p>`;
    html += `</div>`;
  }
  
  html += `</div>`;
  console.log('Generated HTML:', html);
  return html;
}

function displayCompatibilityResult(userNumber, partnerNumber, compatibility) {
  const resultEl = document.getElementById('compatibility-result');
  
  let html = `<h4>T∆∞∆°ng th√≠ch gi·ªØa s·ªë ${userNumber} v√† s·ªë ${partnerNumber}</h4>`;
  html += `<p><strong>M·ª©c ƒë·ªô t∆∞∆°ng th√≠ch:</strong> <span class="tag ${getCompatibilityClass(compatibility)}">${compatibility}</span></p>`;
  
  html += getCompatibilityDescription(userNumber, partnerNumber, compatibility);
  
  resultEl.innerHTML = html;
}

function getCompatibilityClass(compatibility) {
  switch (compatibility) {
    case 'R·∫•t t·ªët': return 'good';
    case 'T·ªët': return 'good';
    case 'B√¨nh th∆∞·ªùng': return 'warn';
    case 'Kh√≥ khƒÉn': return 'bad';
    default: return 'warn';
  }
}

function getCompatibilityDescription(num1, num2, compatibility) {
  const descriptions = {
    'R·∫•t t·ªët': 'Hai b·∫°n c√≥ s·ª± h√≤a h·ª£p tuy·ªát v·ªùi, b·ªï tr·ª£ l·∫´n nhau v√† c√≥ th·ªÉ x√¢y d·ª±ng m·ªëi quan h·ªá b·ªÅn v·ªØng.',
    'T·ªët': 'M·ªëi quan h·ªá kh√° t·ªët v·ªõi nhi·ªÅu ƒëi·ªÉm chung v√† √≠t xung ƒë·ªôt.',
    'B√¨nh th∆∞·ªùng': 'C·∫ßn hi·ªÉu bi·∫øt v√† th·∫•u hi·ªÉu l·∫´n nhau nhi·ªÅu h∆°n ƒë·ªÉ x√¢y d·ª±ng m·ªëi quan h·ªá t·ªët.',
    'Kh√≥ khƒÉn': 'C√≥ nh·ªØng kh√°c bi·ªát c∆° b·∫£n c·∫ßn ƒë∆∞·ª£c gi·∫£i quy·∫øt th√¥ng qua giao ti·∫øp v√† th·∫•u hi·ªÉu.'
  };
  
  let html = `<p>${descriptions[compatibility] || 'C·∫ßn t√¨m hi·ªÉu th√™m v·ªÅ nhau.'}</p>`;
  
  // Th√™m l·ªùi khuy√™n c·ª• th·ªÉ d·ª±a tr√™n t·ª´ng c·∫∑p s·ªë
  html += getSpecificAdvice(num1, num2);
  
  return html;
}

function getSpecificAdvice(num1, num2) {
  // M·ªôt s·ªë l·ªùi khuy√™n c·ª• th·ªÉ cho c√°c c·∫∑p s·ªë ph·ªï bi·∫øn
  const adviceMap = {
    '1-2': 'S·ªë 1 c·∫ßn h·ªçc c√°ch l·∫Øng nghe, s·ªë 2 c·∫ßn t·ª± tin h∆°n.',
    '1-3': 'C·∫∑p ƒë√¥i s√°ng t·∫°o v√† nƒÉng ƒë·ªông, c·∫ßn c√¢n b·∫±ng gi·ªØa c√¥ng vi·ªác v√† vui ch∆°i.',
    '2-4': 'C·∫£ hai ƒë·ªÅu tr√¢n tr·ªçng s·ª± ·ªïn ƒë·ªãnh, r·∫•t ph√π h·ª£p ƒë·ªÉ x√¢y d·ª±ng gia ƒë√¨nh.',
    '3-5': 'C·∫∑p ƒë√¥i t·ª± do v√† phi√™u l∆∞u, c·∫ßn t·∫°o cam k·∫øt ƒë·ªÉ duy tr√¨ m·ªëi quan h·ªá.',
    '4-8': 'C·∫£ hai ƒë·ªÅu c√≥ tham v·ªçng v√† th·ª±c t·∫ø, c√≥ th·ªÉ ƒë·∫°t ƒë∆∞·ª£c th√†nh c√¥ng l·ªõn c√πng nhau.',
    '6-9': 'C·∫∑p ƒë√¥i nh√¢n ƒë·∫°o v√† quan t√¢m ƒë·∫øn gia ƒë√¨nh, r·∫•t h√≤a h·ª£p.'
  };
  
  const key1 = `${num1}-${num2}`;
  const key2 = `${num2}-${num1}`;
  
  const advice = adviceMap[key1] || adviceMap[key2];
  
  if (advice) {
    return `<p><strong>L·ªùi khuy√™n:</strong> ${advice}</p>`;
  }
  
  return `<p><strong>L·ªùi khuy√™n:</strong> H√£y t√¨m hi·ªÉu v√† th·∫•u hi·ªÉu t√≠nh c√°ch c·ªßa nhau ƒë·ªÉ x√¢y d·ª±ng m·ªëi quan h·ªá b·ªÅn v·ªØng.</p>`;
}

function checkCompatibility() {
  const number1 = parseInt(document.getElementById('comp-number1').value);
  const number2 = parseInt(document.getElementById('comp-number2').value);
  
  if (isNaN(number1) || isNaN(number2) || number1 < 1 || number1 > 33 || number2 < 1 || number2 > 33) {
    document.getElementById('compatibility-result').innerHTML = 
      '<div class="compatibility-result error">Vui l√≤ng nh·∫≠p s·ªë h·ª£p l·ªá t·ª´ 1-33</div>';
    return;
  }
  
  const compatibility = getCompatibility(number1, number2);
  const resultDiv = document.getElementById('compatibility-result');
  
  let html = `<div class="compatibility-result ${compatibility.score >= 8 ? 'excellent' : compatibility.score >= 6 ? 'good' : compatibility.score >= 4 ? 'fair' : 'poor'}">`;
  html += `<h4>T∆∞∆°ng th√≠ch gi·ªØa s·ªë ${number1} v√† s·ªë ${number2}</h4>`;
  html += `<div class="compatibility-score">`;
  html += `<div class="score-circle" data-score="${compatibility.score}">`;
  html += `<span class="score-text">${compatibility.score}/10</span>`;
  html += `</div>`;
  html += `<div class="score-label">${compatibility.level}</div>`;
  html += `</div>`;
  
  html += `<div class="compatibility-details">`;
  html += `<p><strong>M√¥ t·∫£:</strong> ${compatibility.description}</p>`;
  
  if (compatibility.aspects) {
    html += `<div class="compatibility-aspects">`;
    html += `<div class="aspect-item">`;
    html += `<span class="aspect-label">T√¨nh y√™u:</span>`;
    html += `<div class="aspect-bar"><div class="aspect-fill" style="width: ${compatibility.aspects.emotional * 10}%"></div></div>`;
    html += `<span class="aspect-score">${compatibility.aspects.emotional}/10</span>`;
    html += `</div>`;
    html += `<div class="aspect-item">`;
    html += `<span class="aspect-label">Giao ti·∫øp:</span>`;
    html += `<div class="aspect-bar"><div class="aspect-fill" style="width: ${compatibility.aspects.communication * 10}%"></div></div>`;
    html += `<span class="aspect-score">${compatibility.aspects.communication}/10</span>`;
    html += `</div>`;
    html += `<div class="aspect-item">`;
    html += `<span class="aspect-label">C√¥ng vi·ªác:</span>`;
    html += `<div class="aspect-bar"><div class="aspect-fill" style="width: ${compatibility.aspects.career * 10}%"></div></div>`;
    html += `<span class="aspect-score">${compatibility.aspects.career}/10</span>`;
    html += `</div>`;
    html += `<div class="aspect-item">`;
    html += `<span class="aspect-label">T√†i ch√≠nh:</span>`;
    html += `<div class="aspect-bar"><div class="aspect-fill" style="width: ${compatibility.aspects.financial * 10}%"></div></div>`;
    html += `<span class="aspect-score">${compatibility.aspects.financial}/10</span>`;
    html += `</div>`;
    html += `</div>`;
  }
  
  if (compatibility.advice) {
    html += `<div class="compatibility-advice">`;
    html += `<h5>L·ªùi khuy√™n cho m·ªëi quan h·ªá:</h5>`;
    html += `<p>${compatibility.advice}</p>`;
    html += `</div>`;
  }
  
  if (compatibility.challenges) {
    html += `<div class="compatibility-challenges">`;
    html += `<h5>Nh·ªØng th√°ch th·ª©c c·∫ßn l∆∞u √Ω:</h5>`;
    html += `<p>${compatibility.challenges}</p>`;
    html += `</div>`;
  }
  
  html += `</div></div>`;
  resultDiv.innerHTML = html;
}

function analyzeName() {
  const fullName = document.getElementById('full-name-analysis')?.value?.trim();
  
  if (!fullName) {
    document.getElementById('name-analysis-result').innerHTML = 
      '<div class="error">Vui l√≤ng nh·∫≠p h·ªç v√† t√™n ƒë·∫ßy ƒë·ªß</div>';
    return;
  }
  
  const analysis = analyzeNameNumerology(fullName);
  const resultDiv = document.getElementById('name-analysis-result');
  
  let html = '<div class="name-analysis-results">';
  html += `<h4>Ph√¢n t√≠ch t√™n: ${analysis.fullName}</h4>`;
  
  // Hi·ªÉn th·ªã c√°c th√†nh ph·∫ßn t√™n
  html += '<div class="name-parts">';
  html += `<p><strong>H·ªç:</strong> ${analysis.nameParts.lastName}</p>`;
  if (analysis.nameParts.middleName) {
    html += `<p><strong>T√™n ƒë·ªám:</strong> ${analysis.nameParts.middleName}</p>`;
  }
  html += `<p><strong>T√™n:</strong> ${analysis.nameParts.firstName}</p>`;
  html += '</div>';
  
  // Hi·ªÉn th·ªã c√°c s·ªë quan tr·ªçng
  html += '<div class="name-numbers">';
  
  // S·ªë bi·ªÉu ƒë·∫°t
  html += '<div class="number-section">';
  html += `<h5>S·ªë Bi·ªÉu ƒë·∫°t (${analysis.numbers.expression.calculation})</h5>`;
  html += formatNumberMeaning(analysis.numbers.expression.meaning);
  html += '</div>';
  
  // S·ªë linh h·ªìn
  html += '<div class="number-section">';
  html += `<h5>S·ªë Linh h·ªìn (${analysis.numbers.soul.calculation})</h5>`;
  html += formatNumberMeaning(analysis.numbers.soul.meaning);
  html += '</div>';
  
  // S·ªë nh√¢n c√°ch
  html += '<div class="number-section">';
  html += `<h5>S·ªë Nh√¢n c√°ch (${analysis.numbers.personality.calculation})</h5>`;
  html += formatNumberMeaning(analysis.numbers.personality.meaning);
  html += '</div>';
  
  html += '</div></div>';
  resultDiv.innerHTML = html;
}

function analyzePhone() {
  const phoneNumber = document.getElementById('phone-analysis')?.value?.trim();
  
  if (!phoneNumber) {
    document.getElementById('phone-analysis-result').innerHTML = 
      '<div class="error">Vui l√≤ng nh·∫≠p s·ªë ƒëi·ªán tho·∫°i</div>';
    return;
  }
  
  const analysis = analyzePhoneNumerology(phoneNumber);
  const resultDiv = document.getElementById('phone-analysis-result');
  
  if (analysis.error) {
    resultDiv.innerHTML = `<div class="error">${analysis.error}</div>`;
    return;
  }
  
  let html = '<div class="phone-analysis-results">';
  html += `<h4>Ph√¢n t√≠ch s·ªë: ${analysis.phoneNumber}</h4>`;
  html += `<p><strong>S·ªë ƒë√£ l√†m s·∫°ch:</strong> ${analysis.cleanPhone}</p>`;
  
  // S·ªë ch√≠nh c·ªßa ƒëi·ªán tho·∫°i
  html += '<div class="phone-number-section">';
  html += `<h5>S·ªë ch√≠nh (${analysis.analysis.mainNumber.calculation})</h5>`;
  html += formatNumberMeaning(analysis.analysis.mainNumber.meaning);
  html += '</div>';
  
  // S·ªë c√° nh√¢n (4 s·ªë cu·ªëi)
  html += '<div class="phone-number-section">';
  html += `<h5>S·ªë c√° nh√¢n (${analysis.analysis.personalNumber.calculation})</h5>`;
  html += formatNumberMeaning(analysis.analysis.personalNumber.meaning);
  html += '</div>';
  
  // S·ªë ƒë·∫ßu s·ªë
  html += '<div class="phone-number-section">';
  html += `<h5>·∫¢nh h∆∞·ªüng ƒë·∫ßu s·ªë (${analysis.analysis.prefixNumber.calculation})</h5>`;
  html += formatNumberMeaning(analysis.analysis.prefixNumber.meaning);
  html += '</div>';
  
  // S·ªë th·ªëng tr·ªã
  html += '<div class="phone-number-section">';
  html += `<h5>S·ªë th·ªëng tr·ªã: ${analysis.analysis.dominantDigit.digit} (xu·∫•t hi·ªán ${analysis.analysis.dominantDigit.frequency} l·∫ßn)</h5>`;
  html += formatNumberMeaning(analysis.analysis.dominantDigit.meaning);
  html += '</div>';
  
  // Bi·ªÉu ƒë·ªì t·∫ßn su·∫•t
  html += '<div class="digit-frequency">';
  html += '<h5>T·∫ßn su·∫•t c√°c ch·ªØ s·ªë:</h5>';
  html += '<div class="frequency-chart">';
  for (let digit = 0; digit <= 9; digit++) {
    const frequency = analysis.analysis.digitFrequency[digit];
    const percentage = frequency > 0 ? (frequency / analysis.cleanPhone.length * 100) : 0;
    html += `<div class="frequency-bar">`;
    html += `<span class="digit">${digit}</span>`;
    html += `<div class="bar"><div class="fill" style="width: ${percentage}%"></div></div>`;
    html += `<span class="count">${frequency}</span>`;
    html += `</div>`;
  }
  html += '</div></div>';
  
  html += '</div>';
  resultDiv.innerHTML = html;
}

function checkNumberCompatibility() {
  const number1 = parseInt(document.getElementById('comp-number1')?.value);
  const number2 = parseInt(document.getElementById('comp-number2')?.value);
  
  if (isNaN(number1) || isNaN(number2) || number1 < 1 || number1 > 33 || number2 < 1 || number2 > 33) {
    document.getElementById('number-compatibility-result').innerHTML = 
      '<div class="error">Vui l√≤ng nh·∫≠p hai s·ªë h·ª£p l·ªá t·ª´ 1-33</div>';
    return;
  }
  
  const compatibility = getCompatibility(number1, number2);
  const resultDiv = document.getElementById('number-compatibility-result');
  
  let html = `<div class="compatibility-result ${compatibility.score >= 8 ? 'excellent' : compatibility.score >= 6 ? 'good' : compatibility.score >= 4 ? 'fair' : 'poor'}">`;
  html += `<h4>T∆∞∆°ng th√≠ch gi·ªØa s·ªë ${number1} v√† s·ªë ${number2}</h4>`;
  html += `<div class="compatibility-score">`;
  html += `<div class="score-circle" data-score="${compatibility.score}">`;
  html += `<span class="score-text">${compatibility.score}/10</span>`;
  html += `</div>`;
  html += `<div class="score-label">${compatibility.level}</div>`;
  html += `</div>`;
  
  html += `<div class="compatibility-details">`;
  html += `<p><strong>M√¥ t·∫£:</strong> ${compatibility.description}</p>`;
  
  if (compatibility.aspects) {
    html += `<div class="compatibility-aspects">`;
    html += `<div class="aspect-item">`;
    html += `<span class="aspect-label">T√¨nh y√™u:</span>`;
    html += `<div class="aspect-bar"><div class="aspect-fill" style="width: ${compatibility.aspects.emotional * 10}%"></div></div>`;
    html += `<span class="aspect-score">${compatibility.aspects.emotional}/10</span>`;
    html += `</div>`;
    html += `<div class="aspect-item">`;
    html += `<span class="aspect-label">Giao ti·∫øp:</span>`;
    html += `<div class="aspect-bar"><div class="aspect-fill" style="width: ${compatibility.aspects.communication * 10}%"></div></div>`;
    html += `<span class="aspect-score">${compatibility.aspects.communication}/10</span>`;
    html += `</div>`;
    html += `<div class="aspect-item">`;
    html += `<span class="aspect-label">C√¥ng vi·ªác:</span>`;
    html += `<div class="aspect-bar"><div class="aspect-fill" style="width: ${compatibility.aspects.career * 10}%"></div></div>`;
    html += `<span class="aspect-score">${compatibility.aspects.career}/10</span>`;
    html += `</div>`;
    html += `<div class="aspect-item">`;
    html += `<span class="aspect-label">T√†i ch√≠nh:</span>`;
    html += `<div class="aspect-bar"><div class="aspect-fill" style="width: ${compatibility.aspects.financial * 10}%"></div></div>`;
    html += `<span class="aspect-score">${compatibility.aspects.financial}/10</span>`;
    html += `</div>`;
    html += `</div>`;
  }
  
  if (compatibility.advice) {
    html += `<div class="compatibility-advice">`;
    html += `<h5>L·ªùi khuy√™n cho m·ªëi quan h·ªá:</h5>`;
    html += `<p>${compatibility.advice}</p>`;
    html += `</div>`;
  }
  
  if (compatibility.challenges) {
    html += `<div class="compatibility-challenges">`;
    html += `<h5>Nh·ªØng th√°ch th·ª©c c·∫ßn l∆∞u √Ω:</h5>`;
    html += `<p>${compatibility.challenges}</p>`;
    html += `</div>`;
  }
  
  html += `</div></div>`;
  resultDiv.innerHTML = html;
}