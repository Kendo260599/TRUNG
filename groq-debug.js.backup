// Groq Debug Service - Enhanced logging for troubleshooting
// Ultra-fast LLM inference with detailed debugging

class GroqServiceDebug extends GroqService {
    constructor() {
        super();
        this.debugMode = true;
        console.log('ğŸš€ GroqServiceDebug initialized');
        console.log('ğŸ“‹ Configuration:', {
            model: this.model,
            maxTokens: this.maxTokens,
            temperature: this.temperature,
            hasApiKey: !!this.apiKey
        });
    }

    // Enhanced API call with detailed logging
    async makeAPICall(messages, options = {}) {
        const startTime = Date.now();
        
        try {
            console.log('ğŸ”µ Starting Groq API call...');
            console.log('ğŸ“¨ Request messages:', messages);
            console.log('âš™ï¸ Options:', options);
            
            const requestBody = {
                model: options.model || this.model,
                messages: messages,
                max_tokens: options.maxTokens || this.maxTokens,
                temperature: options.temperature || this.temperature,
                stream: false
            };

            console.log('ğŸ“¦ Request body:', requestBody);

            const response = await fetch(this.apiUrl, {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${this.apiKey}`,
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(requestBody)
            });

            const duration = Date.now() - startTime;
            console.log(`â±ï¸ Response time: ${duration}ms`);
            console.log('ğŸ“Š Response status:', response.status);
            console.log('ğŸ“Š Response headers:', Object.fromEntries(response.headers.entries()));

            if (!response.ok) {
                const errorData = await response.text();
                console.error('âŒ API Error Response:', errorData);
                throw new Error(`Groq API error: ${response.status} - ${errorData}`);
            }

            const data = await response.json();
            console.log('âœ… API Response data:', data);
            
            const result = data.choices[0].message.content;
            console.log(`ğŸ‰ Groq API call successful! (${duration}ms)`);
            console.log('ğŸ“ Result length:', result.length, 'characters');
            
            return result;
        } catch (error) {
            const duration = Date.now() - startTime;
            console.error(`âŒ Groq API call failed after ${duration}ms:`, error);
            console.error('ğŸ” Error details:', {
                name: error.name,
                message: error.message,
                stack: error.stack
            });
            throw error;
        }
    }

    // Debug version of checkConfiguration
    async checkConfiguration() {
        console.log('ğŸ”§ Checking Groq configuration...');
        
        try {
            if (!this.apiKey || this.apiKey === 'YOUR_GROQ_API_KEY_HERE') {
                console.warn('âš ï¸ Groq API key not configured');
                console.log('Current API key:', this.apiKey ? `${this.apiKey.substring(0, 10)}...` : 'undefined');
                return false;
            }
            
            console.log('âœ… API key found:', `${this.apiKey.substring(0, 15)}...`);
            console.log('ğŸŒ API URL:', this.apiUrl);
            console.log('ğŸ¤– Model:', this.model);
            
            // Test API connection with simple request
            console.log('ğŸ§ª Testing API connection...');
            const testResponse = await this.testAPI();
            console.log('âœ… API test successful:', testResponse);
            
            return true;
        } catch (error) {
            console.error('âŒ Configuration check failed:', error);
            return false;
        }
    }

    // Enhanced test API with more detailed output
    async testAPI() {
        console.log('ğŸ§ª Running Groq API test...');
        
        const messages = [
            {
                role: "system",
                content: "Báº¡n lÃ  AI trá»£ lÃ½ thÃ´ng minh vÃ  thÃ¢n thiá»‡n."
            },
            {
                role: "user",
                content: "Xin chÃ o! Groq API hoáº¡t Ä‘á»™ng tá»‘t khÃ´ng? HÃ£y tráº£ lá»i ngáº¯n gá»n báº±ng tiáº¿ng Viá»‡t."
            }
        ];

        try {
            const result = await this.makeAPICall(messages, { maxTokens: 100 });
            console.log('ğŸ‰ Groq API test completed successfully!');
            return result;
        } catch (error) {
            console.error('âŒ Groq API test failed:', error);
            throw error;
        }
    }

    // Debug version of analyzeFengShui
    async analyzeFengShui(data, detailLevel = 'detailed') {
        console.log('ğŸ  Starting Feng Shui analysis with Groq...');
        console.log('ğŸ“Š Input data:', data);
        console.log('ğŸ“ Detail level:', detailLevel);
        
        try {
            const result = await super.analyzeFengShui(data, detailLevel);
            console.log('âœ… Feng Shui analysis completed successfully');
            console.log('ğŸ“ Result preview:', result.substring(0, 200) + '...');
            return result;
        } catch (error) {
            console.error('âŒ Feng Shui analysis failed:', error);
            throw error;
        }
    }

    // Debug version of analyzeNumerology
    async analyzeNumerology(data, detailLevel = 'detailed') {
        console.log('ğŸ”¢ Starting Numerology analysis with Groq...');
        console.log('ğŸ“Š Input data:', data);
        console.log('ğŸ“ Detail level:', detailLevel);
        
        try {
            const result = await super.analyzeNumerology(data, detailLevel);
            console.log('âœ… Numerology analysis completed successfully');
            console.log('ğŸ“ Result preview:', result.substring(0, 200) + '...');
            return result;
        } catch (error) {
            console.error('âŒ Numerology analysis failed:', error);
            throw error;
        }
    }

    // Debug version of chatWithContext
    async chatWithContext(userMessage, userData, options = {}) {
        console.log('ğŸ’¬ Starting AI Chat with context...');
        console.log('ï¿½ User message:', userMessage);
        console.log('ï¿½ğŸ“Š User data:', userData);
        console.log('âš™ï¸ Options:', options);
        
        try {
            const result = await super.chatWithContext(userMessage, userData, options);
            console.log('âœ… AI Chat completed successfully');
            console.log('ğŸ“ Response preview:', result.substring(0, 200) + '...');
            return result;
        } catch (error) {
            console.error('âŒ AI Chat failed:', error);
            throw error;
        }
    }

    // Performance benchmark
    async benchmarkAPI() {
        console.log('ğŸƒâ€â™‚ï¸ Running Groq API performance benchmark...');
        
        const tests = [
            'Test ngáº¯n',
            'Test trung bÃ¬nh vá»›i ná»™i dung dÃ i hÆ¡n má»™t chÃºt Ä‘á»ƒ kiá»ƒm tra hiá»‡u suáº¥t',
            'Test dÃ i vá»›i ráº¥t nhiá»u ná»™i dung Ä‘á»ƒ Ä‘Ã¡nh giÃ¡ kháº£ nÄƒng xá»­ lÃ½ cá»§a Groq API khi cÃ³ input lá»›n vÃ  yÃªu cáº§u response chi tiáº¿t hÆ¡n'
        ];
        
        const results = [];
        
        for (let i = 0; i < tests.length; i++) {
            const startTime = Date.now();
            try {
                const result = await this.makeAPICall([
                    { role: "user", content: tests[i] }
                ], { maxTokens: 50 });
                
                const duration = Date.now() - startTime;
                results.push({ test: i + 1, duration, success: true });
                console.log(`âœ… Test ${i + 1}: ${duration}ms`);
            } catch (error) {
                const duration = Date.now() - startTime;
                results.push({ test: i + 1, duration, success: false, error: error.message });
                console.log(`âŒ Test ${i + 1}: ${duration}ms (failed)`);
            }
        }
        
        console.log('ğŸ“Š Benchmark results:', results);
        return results;
    }
}

// Export for use in other files
window.GroqServiceDebug = GroqServiceDebug;

// Auto-test on load if debug mode
if (typeof window !== 'undefined' && window.CONFIG?.DEBUG_MODE) {
    window.addEventListener('load', async () => {
        console.log('ğŸ” Auto-testing Groq in debug mode...');
        try {
            const debugService = new GroqServiceDebug();
            await debugService.checkConfiguration();
        } catch (error) {
            console.error('âŒ Auto-test failed:', error);
        }
    });
}
